class User::VerificationCode < ActiveRecord::Base
  # extends ...................................................................
  # includes ..................................................................
  # constants .................................................................
  self.table_name = "verification_codes"
  # related macros ............................................................
  # relationships .............................................................
  belongs_to :user
  # validations ...............................................................
  validates_uniqueness_of :mobile
  # callbacks .................................................................
  after_create :send_code
  # scopes ....................................................................
  # other macros (like devise's) ..............................................
  # class methods .............................................................
  class << self

    def registration_code(mobile)
      code = rand(999999)
      User::VerificationCode.create(code: code, mobile: mobile)
      #User::Sms.send_message(mobile,'twMG94',"sms_reg_code : #{code}")
    end

    def verify_code(mobile)
      verification_code = User::VerificationCode.find_by(mobile: mobile, user_id: nil )
      if Time.now - verification_code.updated_at < 2.minute
        verification_code.code 
      else
        verification_code.update(code: rand(999999))
        verification_code.code 
      end
    end
  end
  # public instance methods ...................................................
  # protected instance methods ................................................
  # private instance methods ..................................................
  private
  def send_code
    User::VerificationCode.registration_code(self.mobile)
  end
end
